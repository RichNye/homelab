- name: setup db servers
  hosts: db_servers
  remote_user: "{{ remote_user }}"
  become: yes

  tasks:
  - name: install postgres servers
    ansible.builtin.apt:
      name: postgresql
      state: present
      update_cache: yes

  - name: install required packages
    ansible.builtin.apt:
      name:
        - acl
        - psycopg2
      state: present
      update_cache: yes

  - name: ensure postgresql is running
    ansible.builtin.service:
      name: postgresql
      state: started
      enabled: yes

  - name: create postgresql mealplanner user
    community.postgresql.postgresql_user:
      name: "{{ database_user }}"
      password: mealplanner
      state: present
    become: yes
    become_user: postgres
    become_method: sudo

  - name: create mealplanner database
    community.postgresql.postgresql_db:
      name: "{{ database_name }}"
      owner: "{{ database_user }}"
      state: present
    become: yes
    become_user: postgres
    become_method: sudo

